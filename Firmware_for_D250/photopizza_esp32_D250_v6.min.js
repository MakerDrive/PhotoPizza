var config={};function PhotoPizzaInit(){var photoPizzaIp='192.168.4.1';var wifi=require('Wifi');var wsocket;var server;var wifiSsid=config.wifiSsid;var wifiPassword=config.wifiPassword;var attempt=1;var displaywifiPassword='9992030360';var displaywifiName='PhotoPizza';wifi.startAP('PhotoPizza',{password:'9992030360',authMode:'wpa2'},function(err){if(err)throw err;console.log("Connected!");wifiConnect_=true;if(wifiConnect_){server=require('ws').createServer();server.listen(config.wsPort);server.on("websocket",function(ws){wsocket=ws;ws.send(JSON.stringify(config));ws.on('message',function(msg){var configIn=JSON.parse(msg);config=configIn;config.speed=1;saveConfig();if(configIn.state==='start'&&config.state!='started'){start();config.state='started';ws.send(JSON.stringify(config));}
if(configIn.state==='infinity'&&config.state!='started'){start();ws.send(JSON.stringify(config));}
if(configIn.state==='stop'){stop();}
if(configIn.state==='save'&&config.state!='started'){config.state='waiting';saveConfig();ws.send(JSON.stringify(config));}});ws.on('close',function(){wsocket=false;});});}
printDisplay();});function saveConfig(){if(JSON.stringify(config)!=fs.readFileSync("config.txt")){fs.writeFileSync('config.txt',JSON.stringify(config));console.log('Save config');}}
var step=0;var steps=[];var stepperPins=[D12,D14,D27,D26];var speed;var _speed=3;var accSteps=0;var pinShot=D25;var pinLaser=D33;var relayOn=false;var rOn=0;var rOff=1;digitalWrite(pinShot,rOff);digitalWrite(pinLaser,rOn);require("IRReceiver").connect(D13,function(code){var _code=parseInt(code,2);var btn;if(_code===6450803341||_code===25803213367){btn=1;console.log(btn);}
if(_code===6450819151||_code===25803276607){btn=2;console.log(btn);}
if(_code===6450786511||_code===25803146047){btn=3;console.log(btn);}
if(_code===6450795181||_code===25803180727){btn=4;console.log(btn);}
if(_code===6450810991||_code===25803243967){btn=5;console.log(btn);}
if(_code===6450778351||_code===25803113407){btn=6;console.log(btn);}
if(_code===6450799261||_code===25803197047){btn=7;console.log(btn);}
if(_code===6450815071||_code===25803260287){btn=8;console.log(btn);}
if(_code===6450782431||_code===25803129727){btn=9;console.log(btn);}
if(_code===6450806911||_code===25803227647){btn=0;console.log(btn);}
if(_code===25803148087||_code===6450787021){btn='CALIBR';console.log(btn);}
if(_code===6450823741||_code===25803294967){btn='SETUP';console.log(btn);}
if(_code===6450800791||_code===25803203167){btn='UP';console.log(btn);}
if(_code===6450796711||_code===25803186847){btn='DOWN';console.log(btn);}
if(_code===6450809461||_code===25803237847){btn='LEFT';console.log(btn);}
if(_code===6450776821||_code===25803107287){btn='RIGHT';console.log(btn);}
if(_code===6450825271||_code===25803301087){btn='OK';console.log(btn);}
if(_code===6450813031||_code===25803252127){btn='90DEG';console.log(btn);}
console.log(_code);console.log(config.state);if(btn==='OK'&&config.state==='started'||btn==='OK'&&config.state==='infinity'){stop();console.log('OK STOP');return;}
if(btn==='OK'&&config.state==='waiting'){start();config.state='started';console.log('OK START');return;}
if(btn==='RIGHT'&&config.state==='waiting'){config.direction=1;config.state='infinity';start();return;}
if(btn==='LEFT'&&config.state==='waiting'){config.direction=0;config.state='infinity';start();return;}});function printDisplay(){g.clear();g.setFont8x16();g.drawString('WiFi: '+displaywifiName,0,14);g.drawString('Pass: '+displaywifiPassword,0,31);g.drawString('IP: '+photoPizzaIp,0,48);g.flip();}
function sendConfig(){if(wsocket){wsocket.send(JSON.stringify(config));}}
function start(){digitalWrite(pinLaser,rOff);if(config.direction===1){steps=[0b0001,0b0010,0b0100,0b1000];}else{steps=[0b1000,0b0100,0b0010,0b0001];}
if(config.speed>100){config.speed=100;}else if(config.speed<1){config.speed=1;}
speed=100 / config.speed;config.framesLeft=config.frame;accSteps=(config.allSteps / config.frame)/ 4;step=0;if(config.state==='infinity'){doStep();return;}
shot();}
function stop(){config.state='stopping';digitalWrite(pinLaser,rOn);console.log('STOP');}
function shot(){console.log('SHOT');if(config.framesLeft===0){config.state='waiting';sendConfig();return;}
digitalWrite(pinShot,rOn);sendConfig();var shotTimeout=setTimeout(function(){digitalWrite(pinShot,rOff);config.framesLeft--;step=0;doStep();},config.delay);}
function doStep(){if(config.state==='stopping'){config.state='waiting';sendConfig();return;}
step++;if(step>=config.allSteps / config.frame&&config.state!='infinity'){pause();return;}
digitalWrite(stepperPins,steps[step%steps.length]);step++;digitalWrite(stepperPins,steps[step%steps.length]);var stepTimeout=setTimeout(function(){doStep();},config.speed);}
function pause(){console.log('PAUSE');var pauseTimeout=setTimeout(function(){shot();},config.pause);}
console.log(config);g=require("SH1106").connect(I2C1,printDisplay);wifiConnect();}
function onInit(){I2C1.setup({scl:D22,sda:D21});fs=require("fs");require("Font8x16").add(Graphics);config=JSON.parse(fs.readFileSync("config.txt"));config.state='waiting';config.speed=1;var riadTimer=setTimeout(function(){PhotoPizzaInit();},1000);}
var config={},run=function(){function e(){fs.writeFileSync("cfg.htm",JSON.stringify(config)),console.log("Save config")}var t,n,o="disconnected",a=require("Wifi"),c=1,s=!1;function f(){o="connection",R(),a.connect(config.wifiSsid,{password:config.wifiPassword},function(){console.log(a.getIP()),o=a.getIP().ip,s=!0,R()}),s&&((n=require("ws").createServer()).listen(config.wsPort),n.on("websocket",function(n){(t=n).send(JSON.stringify(config)),n.on("message",function(i){var t=JSON.parse(i);config=t,U(),"start"===t.state&&"started"!=config.state&&(A(),config.state="started",n.send(JSON.stringify(config))),"infinity"===t.state&&"started"!=config.state&&(M(),n.send(JSON.stringify(config))),"stop"===t.state&&K(),"save"===t.state&&"started"!=config.state&&(e(),config.state="waiting",n.send(JSON.stringify(config)))}),n.on("close",function(){t=!1})})),a.on("disconnected",function(){if(t=s=!1,console.log("Lost WIFI! Disconnected."),o="disconnected",R(),1<=c){c--;setTimeout(function(){f()},2e3)}})}a.startAP("PhotoPizza",{password:"9992030360",authMode:"wpa2"},function(i){if(i)throw i;console.log("Connected!"),o="192.168.4.1",(s=!0)&&((n=require("ws").createServer()).listen(config.wsPort),n.on("websocket",function(n){(t=n).send(JSON.stringify(config)),n.on("message",function(i){var t=JSON.parse(i);config=t,U(),"start"===t.state&&"started"!=config.state&&(A(),config.state="started",n.send(JSON.stringify(config))),"infinity"===t.state&&"started"!=config.state&&(M(),n.send(JSON.stringify(config))),"stop"===t.state&&K(),"save"===t.state&&"started"!=config.state&&(config.state="waiting",e(),n.send(JSON.stringify(config)))}),n.on("close",function(){t=!1})})),a.on("disconnected",function(){if(t=s=!1,console.log("Lost WIFI! Disconnected."),o="disconnected",R(),1<=c){c--;setTimeout(function(){f()},2e3)}}),R()});var r="1",l=0,d=!0,p=0,u=13,i="",S=48,w=D12,y=D27,v=D14,W=1;digitalWrite(w,0),digitalWrite(y,1),digitalWrite(v,config.direction);var m,I,O,_,P,L,T,D,h,E=D26,N=D25,F=0,q=1;function R(){d&&(g.clear(),g.setFontVector(35),g.drawString(config.framesLeft+" f",0,0),g.flip(),g.setFontVector(8),g.drawString("IP:"+o,0,45),g.flip())}function J(){d&&(config.state="dispay_1",4*u<p?p=0:p<0&&(p=4*u),g.clear(),g.setFontVector(8),g.drawString(">",1,p),g.drawString(">",117,28),g.drawString("1",117,0),g.drawLine(112,0,112,127),g.drawString("frame",8,0),g.drawString("=",S,0),g.drawString(config.frame,57,0),g.drawString("delay",8,u),g.drawString("=",S,u),g.drawString(config.delay,57,u),g.drawString("pause",8,2*u),g.drawString("=",S,2*u),g.drawString(config.pause,57,2*u),g.drawString("speed",8,3*u),g.drawString("=",S,3*u),g.drawString(config.speed,57,3*u),g.drawString("accel",8,4*u),g.drawString("=",S,4*u),g.drawString(config.acceleration,57,4*u),g.flip())}function V(){d&&(i=1===config.direction?"right":"left",config.state="dispay_2",2*u<p?p=0:p<0&&(p=2*u),g.clear(),g.setFontVector(8),g.drawString(">",1,p),g.drawString("<",117,28),g.drawString("2",117,0),g.drawLine(112,0,112,127),S=48,g.drawString("mode",8,0),g.drawString("=",S,0),g.drawString(config.shootingMode,57,0),g.drawString("direc",8,u),g.drawString("=",S,u),g.drawString(i,57,u),g.drawString("steps",8,2*u),g.drawString("=",S,2*u),g.drawString(config.allSteps,57,2*u),g.flip())}function U(){console.log("NumControl"),D=config.allSteps/config.frame/4,h=config.speed/D*10,config.framesLeft=config.frame,W=1;var i=config.allSteps/config.frame;m=i/config.speed*500;var t=i/4;I=m/4,(O=Math.floor(.04*t))<=0&&(O=1),_=I/O,P=config.pause+config.delay+m,L=P*config.frame,T=m,digitalWrite(v,config.direction)}function b(){if(digitalWrite(y,0),digitalWrite(N,q),"nonST"===config.shootingMode)return config.state="started",void function(){config.state="started",digitalWrite(N,q),G(),config.framesLeft--,R(),analogWrite(w,.5,{freq:config.speed});var i=setInterval(function(){if(config.framesLeft<=0)return clearInterval(i),void C();G(),config.framesLeft--,R()},T)}();var i;0<config.framesLeft?(config.state="started",i=setTimeout(function(){!function(){if(console.log("Relay"),0<config.framesLeft){digitalWrite(E,F),config.framesLeft--;var i=setTimeout(function(){digitalWrite(E,q),t&&t.send(JSON.stringify(config)),R(),function(){config.state="started",W=1;var i=config.allSteps/config.frame,t=setInterval(function(){if(3*D<i&&W<config.speed&&(W+=h,analogWrite(w,.5,{freq:W})),i<=D&&100<W&&((W-=h)<h+100&&(W=100),analogWrite(w,.5,{freq:W})),W>config.speed&&(W=config.speed,analogWrite(w,.5,{freq:W})),(i-=W/100)<=0)return clearInterval(t),digitalWrite(w,0),void b()},10)}(),clearTimeout(i)},config.delay)}else C()}(),clearTimeout(i)},config.pause)):C()}function C(){console.log(W),1+h<W?function(){if(config.state="started",W<=1)return C();var i=setInterval(function(){if(W<=1+h)return clearInterval(i),void C();W-=h,analogWrite(w,.5,{freq:W})},10)}():(console.log("stop"),clearInterval(),config.state="waiting",digitalWrite(w,0),digitalWrite(y,1),digitalWrite(E,q),digitalWrite(N,F),U(),R(),t&&(config.state="waiting",t.send(JSON.stringify(config))))}function G(){console.log("shot"),digitalWrite(E,F),config.state="shot";var i=setTimeout(function(){config.state="waiting",digitalWrite(E,q),clearTimeout(i)},config.delay)}function K(){console.log("BtnStop"),C()}function A(){R(),b()}function M(){config.state="infinite",digitalWrite(N,q),g.clear(),g.setFontVector(20),g.drawString("infinite",0,0),g.flip(),digitalWrite(y,0);var i=setInterval(function(){analogWrite(w,.5,{freq:W}),(W+=h)>=config.speed&&(clearInterval(i),analogWrite(w,.5,{freq:config.speed}))},_)}digitalWrite(E,q),digitalWrite(N,F),require("IRReceiver").connect(D13,function(i){var t,n=parseInt(i,2);if(6450803341!==n&&25803213367!==n||(t=1,console.log(t)),6450819151!==n&&25803276607!==n||(t=2,console.log(t)),6450786511!==n&&25803146047!==n||(t=3,console.log(t)),6450795181!==n&&25803180727!==n||(t=4,console.log(t)),6450810991!==n&&25803243967!==n||(t=5,console.log(t)),6450778351!==n&&25803113407!==n||(t=6,console.log(t)),6450799261!==n&&25803197047!==n||(t=7,console.log(t)),6450815071!==n&&25803260287!==n||(t=8,console.log(t)),6450782431!==n&&25803129727!==n||(t=9,console.log(t)),6450806911!==n&&25803227647!==n||(t=0,console.log(t)),6450774271!==n&&25803097087!==n||(t="SHOT",console.log(t)),6450794416!==n&&25803177667!==n||(t="SAVE",console.log(t)),25803148087!==n&&6450787021!==n||(t="CALIBR",console.log(t)),25803357187!==n&&6450839296!==n&&6450817621!==n&&25803270487!==n||(t="POWER-W",console.log(t)),6450823741!==n&&25803294967!==n||(t="SETUP",console.log(t)),6450800791!==n&&25803203167!==n||(t="UP",console.log(t)),6450796711!==n&&25803186847!==n||(t="DOWN",console.log(t)),6450809461!==n&&25803237847!==n||(t="LEFT",console.log(t)),6450776821!==n&&25803107287!==n||(t="RIGHT",console.log(t)),6450825271!==n&&25803301087!==n||(t="OK",console.log(t)),6450813031!==n&&25803252127!==n||(t="90DEG",console.log(t)),6450835471!==n&&25803341887!==n||(t="WIFI",console.log(t)),console.log(n),"SAVE"!==t)if("SHOT"!==t)if("POWER-W"!==t){if("number"==typeof t&&"dispay_1"===config.state||"number"==typeof t&&"dispay_2"===config.state||"number"==typeof t&&"newPass"===config.state)return console.log("input"),void function(i){r=i+"","dispay_1"===config.state&&0===p&&l<=7&&0<l&&(config.frame=+(config.frame+r),U(),J(),l++);"dispay_1"===config.state&&0===p&&0===l&&"0"!=r&&(config.frame="",config.frame=+(config.frame+r),U(),J(),l++);"dispay_1"===config.state&&p===u&&l<=7&&0<l&&(config.delay=+(config.delay+r),J(),l++);"dispay_1"===config.state&&p===u&&0===l&&"0"!=r&&(config.delay="",config.delay=+(config.delay+r),J(),l++);"dispay_1"===config.state&&p===2*u&&l<=7&&0<l&&(config.pause=+(config.pause+r),J(),l++);"dispay_1"===config.state&&p===2*u&&0===l&&"0"!=r&&(config.pause="",config.pause=+(config.pause+r),J(),l++);"dispay_1"===config.state&&p===3*u&&l<=7&&0<l&&(config.speed=+(config.speed+r),U(),J(),l++);"dispay_1"===config.state&&p===3*u&&0===l&&"0"!=r&&(config.speed="",config.speed=+(config.speed+r),J(),l++);"dispay_1"===config.state&&p===4*u&&l<=7&&0<l&&(config.acceleration=+(config.acceleration+r),J(),l++);"dispay_1"===config.state&&p===4*u&&0===l&&"0"!=r&&(config.acceleration="",config.acceleration=+(config.acceleration+r),J(),l++);"dispay_2"===config.state&&0===p&&"1"===r&&(config.shootingMode="inter",V());"dispay_2"===config.state&&0===p&&"2"===r&&(config.shootingMode="seria",V());"dispay_2"===config.state&&0===p&&"3"===r&&(config.shootingMode="nonST",V());"dispay_2"===config.state&&0===p&&"4"===r&&(config.shootingMode="PingP",V());"dispay_2"===config.state&&p===u&&"1"===r&&(config.direction=1,V());"dispay_2"===config.state&&p===u&&"2"===r&&(config.direction=0,V());"dispay_2"===config.state&&p===2*u&&l<=7&&0<l&&(config.allSteps=+(config.allSteps+r),U(),V(),l++);"dispay_2"===config.state&&p===2*u&&0===l&&"0"!=r&&(config.allSteps="",config.allSteps=+(config.allSteps+r),U(),V(),l++)}(t);if("SETUP"===t&&"waiting"===config.state)return J(),console.log("Setup"),void(l=0);if("SETUP"===t&&"dispay_1"===config.state||"SETUP"===t&&"dispay_2"===config.state||"SETUP"===t&&"newWifi"===config.state)return config.state="waiting",U(),R(),e(),void console.log("Setup Exit");if("OK"===t&&"started"===config.state||"OK"===t&&"90DEG"===config.state||"OK"===t&&"calibration"===config.state||"OK"===t&&"infinite"===config.state||"OK"===t&&"shot"===config.state)return K(),console.log("OK STOP"),void(l=0);if("OK"===t&&"waiting"===config.state)return A(),console.log("OK START"),void(l=0);if("DOWN"===t&&"dispay_1"===config.state)return p+=u,J(),l=0,void console.log("Down D1");if("DOWN"===t&&"dispay_2"===config.state)return p+=u,V(),console.log("Down D2"),void(l=0);if("UP"===t&&"dispay_1"===config.state)return p-=u,J(),l=0,void console.log("UP D1");if("UP"===t&&"dispay_2"===config.state)return p-=u,V(),console.log("UP D2"),void(l=0);if("RIGHT"===t&&"dispay_1"===config.state)return V(),console.log("Right"),void(l=0);if("LEFT"===t&&"dispay_2"===config.state)return J(),console.log("Left"),void(l=0);if("RIGHT"===t)return digitalWrite(v,1),digitalWrite(w,0),digitalWrite(y,0),W=1,M(),void console.log("Right rotation");if("LEFT"===t)return digitalWrite(v,0),digitalWrite(w,0),digitalWrite(y,0),W=1,M(),void console.log("Left rotation");if("CALIBR"===t&&"dispay_1"===config.state||"CALIBR"===t&&"dispay_2"===config.state)!function(){config.state="calibration",g.clear(),g.setFontVector(20),g.drawString("calibration",0,0),g.flip(),digitalWrite(y,0);config.allSteps=0,analogWrite(w,.5,{freq:config.speed}),setInterval(function(){config.allSteps+=config.speed/100},10)}();else{if("CALIBR"===t&&"calibration"===config.state&&(C(),e()),"90DEG"!==t||"waiting"!==config.state)return"90DEG"===t&&"90DEG"===config.state&&C(),"WIFI"===t&&"waiting"===config.state?(o="connection",R(),f(),console.log("WIFI"),void(l=0)):"UP"===t&&"infinite"===config.state?(config.speed=config.speed+config.stsp,void analogWrite(w,.5,{freq:config.speed})):"DOWN"===t&&"infinite"===config.state&&config.speed>config.stsp?(config.speed=config.speed-config.stsp,void analogWrite(w,.5,{freq:config.speed})):void 0;!function(){config.state="90DEG",g.clear(),g.setFontVector(20),g.drawString("turn to 90",0,0),g.flip(),digitalWrite(y,0),analogWrite(w,.5,{freq:config.speed});var i=0;setInterval(function(){i>=config.allSteps/4&&C(),i+=config.speed/100},10)}()}}else digitalWrite(y,0);else G();else e()}),d&&(g=require("SH1106").connect(I2C1,function(){if(d){var i=1;g.clear(),g.setFontVector(8),g.drawString(config.firmwareVersion,10,45),g.flip();var t=setInterval(function(){g.setContrast(i),g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.flip(),126<i&&(clearInterval(t),U(),R())},10)}else U()}))};function onInit(){I2C1.setup({scl:D22,sda:D21}),fs=require("fs"),(config=JSON.parse(fs.readFileSync("cfg.htm"))).state="waiting",config.firmwareVersion="PhotoPizza v6.1";setTimeout(function(){run()},500)}
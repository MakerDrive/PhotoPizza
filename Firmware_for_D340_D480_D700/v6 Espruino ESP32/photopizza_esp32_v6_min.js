/**
 * File: photopizza_espruino.js
 * Created on: August 30, 2017
 * Description:
 * PhotoPizza DIY is an open source project of 360Â° product photography turntable.
 *
 * Author: Vladimir Matiyasevith <vladimir.m@makerdrive.ru>
 * Project Site: PhotoPizza.org
 *
 * Copyright: 2018 Vladimir Matiyasevith
 * Copying permission statement:
 *  This file is part of PhotoPizza DIY.
 *
 *  PhotoPizza DIY is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>
 *
 */
var config={};var run=function(){function Y(){fs.writeFileSync("cfg.htm",JSON.stringify(config));console.log("Save config")}var N="disconnected";var q=require("Wifi");var u;var H;var d;var Q=1;var h=false;q.startAP("PhotoPizza",{password:"9992030360",authMode:"wpa2"},function(af){if(af){throw af}console.log("Connected!");N="192.168.4.1";h=true;if(h){H=require("ws").createServer();H.listen(config.wsPort);H.on("websocket",function(ag){u=ag;ag.send(JSON.stringify(config));ag.on("message",function(ai){var ah=JSON.parse(ai);config=ah;ac();if(ah.state==="start"&&config.state!="started"){y();config.state="started";ag.send(JSON.stringify(config))}if(ah.state==="infinity"&&config.state!="started"){A();ag.send(JSON.stringify(config))}if(ah.state==="stop"){e()}if(ah.state==="save"&&config.state!="started"){config.state="waiting";Y();ag.send(JSON.stringify(config))}});ag.on("close",function(){u=false})})}q.on("disconnected",function(){h=false;u=false;console.log("Lost WIFI! Disconnected.");N="disconnected";D();if(Q>=1){Q--;var ag=setTimeout(function(){K()},2000)}});D()});function K(){N="connection";D();q.connect(config.wifiSsid,{password:config.wifiPassword},function(){console.log(q.getIP());N=q.getIP().ip;h=true;D()});if(h){H=require("ws").createServer();H.listen(config.wsPort);H.on("websocket",function(af){u=af;af.send(JSON.stringify(config));af.on("message",function(ah){var ag=JSON.parse(ah);config=ag;ac();if(ag.state==="start"&&config.state!="started"){y();config.state="started";af.send(JSON.stringify(config))}if(ag.state==="infinity"&&config.state!="started"){A();af.send(JSON.stringify(config))}if(ag.state==="stop"){e()}if(ag.state==="save"&&config.state!="started"){Y();config.state="waiting";af.send(JSON.stringify(config))}});af.on("close",function(){u=false})})}q.on("disconnected",function(){h=false;u=false;console.log("Lost WIFI! Disconnected.");N="disconnected";D();if(Q>=1){Q--;var af=setTimeout(function(){K()},2000)}})}require("Font8x16").add(Graphics);var aa=0;var I="1";var ad=0;var z=true;var ab=0;var r=13;var U="";var M=48;var W=D12;var a=D27;var X=D14;var T=0;var E=1;var S=1;digitalWrite(W,0);digitalWrite(a,1);digitalWrite(X,config.direction);var w=D26;var t=D25;var V=0;var p=1;digitalWrite(w,p);digitalWrite(t,V);require("IRReceiver").connect(D13,function(ah){var ag=parseInt(ah,2);var af;if(ag===6450803341||ag===25803213367){af=1;console.log(af)}if(ag===6450819151||ag===25803276607){af=2;console.log(af)}if(ag===6450786511||ag===25803146047){af=3;console.log(af)}if(ag===6450795181||ag===25803180727){af=4;console.log(af)}if(ag===6450810991||ag===25803243967){af=5;console.log(af)}if(ag===6450778351||ag===25803113407){af=6;console.log(af)}if(ag===6450799261||ag===25803197047){af=7;console.log(af)}if(ag===6450815071||ag===25803260287){af=8;console.log(af)}if(ag===6450782431||ag===25803129727){af=9;console.log(af)}if(ag===6450806911||ag===25803227647){af=0;console.log(af)}if(ag===6450774271||ag===25803097087){af="SHOT";console.log(af)}if(ag===6450794416||ag===25803177667){af="SAVE";console.log(af)}if(ag===25803148087||ag===6450787021){af="CALIBR";console.log(af)}if(ag===25803357187||ag===6450839296||ag===6450817621||ag===25803270487){af="POWER-W";console.log(af)}if(ag===6450823741||ag===25803294967){af="SETUP";console.log(af)}if(ag===6450800791||ag===25803203167){af="UP";console.log(af)}if(ag===6450796711||ag===25803186847){af="DOWN";console.log(af)}if(ag===6450809461||ag===25803237847){af="LEFT";console.log(af)}if(ag===6450776821||ag===25803107287){af="RIGHT";console.log(af)}if(ag===6450825271||ag===25803301087){af="OK";console.log(af)}if(ag===6450813031||ag===25803252127){af="90DEG";console.log(af)}if(ag===6450835471||ag===25803341887){af="WIFI";console.log(af)}console.log(ag);if(af==="SAVE"){Y();return}if(af==="SHOT"){J();return}if(af==="POWER-W"){digitalWrite(a,0);return}if(typeof(af)==="number"&&config.state==="dispay_1"||typeof(af)==="number"&&config.state==="dispay_2"||typeof(af)==="number"&&config.state==="newPass"){console.log("input");R(af);return}if(af==="SETUP"&&config.state==="waiting"){P();console.log("Setup");ad=0;return}if(af==="SETUP"&&config.state==="dispay_1"||af==="SETUP"&&config.state==="dispay_2"||af==="SETUP"&&config.state==="newWifi"){config.state="waiting";ac();D();Y();console.log("Setup Exit");return}if(af==="OK"&&config.state==="started"||af==="OK"&&config.state==="90DEG"||af==="OK"&&config.state==="calibration"||af==="OK"&&config.state==="infinite"||af==="OK"&&config.state==="shot"){e();console.log("OK STOP");ad=0;return}if(af==="OK"&&config.state==="waiting"){y();console.log("OK START");ad=0;return}if(af==="DOWN"&&config.state==="dispay_1"){ab=ab+r;P();ad=0;console.log("Down D1");return}if(af==="DOWN"&&config.state==="dispay_2"){ab=ab+r;O();console.log("Down D2");ad=0;return}if(af==="UP"&&config.state==="dispay_1"){ab=ab-r;P();ad=0;console.log("UP D1");return}if(af==="UP"&&config.state==="dispay_2"){ab=ab-r;O();console.log("UP D2");ad=0;return}if(af==="RIGHT"&&config.state==="dispay_1"){O();console.log("Right");ad=0;return}if(af==="LEFT"&&config.state==="dispay_2"){P();console.log("Left");ad=0;return}if(af==="RIGHT"){digitalWrite(X,1);digitalWrite(W,0);digitalWrite(a,T);S=1;A();console.log("Right rotation");return}if(af==="LEFT"){digitalWrite(X,0);digitalWrite(W,0);digitalWrite(a,T);S=1;A();console.log("Left rotation");return}if(af==="CALIBR"&&config.state==="dispay_1"||af==="CALIBR"&&config.state==="dispay_2"){j();return}if(af==="CALIBR"&&config.state==="calibration"){i();Y()}if(af==="90DEG"&&config.state==="waiting"){c();return}if(af==="90DEG"&&config.state==="90DEG"){i()}if(af==="WIFI"&&config.state==="waiting"){N="connection";D();K();console.log("WIFI");ad=0;return}});function l(){if(!z){ac();return}var ag=1;g.clear();g.setFontBitmap();g.setFont8x16();g.drawString(config.firmwareVersion,10,45);g.flip();var af=setInterval(function(){g.setContrast(ag);g.drawLine(ag,20,ag,30);ag+=2;g.drawLine(ag,20,ag,30);ag+=2;g.drawLine(ag,20,ag,30);ag+=2;g.drawLine(ag,20,ag,30);ag+=2;g.drawLine(ag,20,ag,30);ag+=2;g.drawLine(ag,20,ag,30);ag+=2;g.flip();if(ag>126){clearInterval(af);ac();D()}},10)}function D(){if(!z){return}g.clear();g.setFontVector(35);g.drawString(config.framesLeft+" f",0,0);g.flip();g.setFontBitmap();g.setFont8x16();g.drawString("IP:"+N,0,45);g.flip()}function P(){if(!z){return}config.state="dispay_1";if(ab>r*4){ab=0}else{if(ab<0){ab=r*4}}g.clear();g.setFontBitmap();g.setFont8x16();g.drawString(">",1,ab);g.drawString(">",117,28);g.drawString("1",117,0);g.drawLine(112,0,112,127);g.drawString("frame",8,0);g.drawString("=",M,0);g.drawString(config.frame,57,0);g.drawString("delay",8,r);g.drawString("=",M,r);g.drawString(config.delay,57,r);g.drawString("pause",8,r*2);g.drawString("=",M,r*2);g.drawString(config.pause,57,r*2);g.drawString("speed",8,r*3);g.drawString("=",M,r*3);g.drawString(config.speed,57,r*3);g.drawString("accel",8,r*4);g.drawString("=",M,r*4);g.drawString(config.acceleration,57,r*4);g.flip()}function O(){if(!z){return}if(config.direction===1){U="right"}else{U="left"}config.state="dispay_2";if(ab>r*2){ab=0}else{if(ab<0){ab=r*2}}g.clear();g.setFontBitmap();g.setFont8x16();g.drawString(">",1,ab);g.drawString("<",117,28);g.drawString("2",117,0);g.drawLine(112,0,112,127);M=48;g.drawString("mode",8,0);g.drawString("=",M,0);g.drawString(config.shootingMode,57,0);g.drawString("direc",8,r);g.drawString("=",M,r);g.drawString(U,57,r);g.drawString("steps",8,r*2);g.drawString("=",M,r*2);g.drawString(config.allSteps,57,r*2);g.flip()}function R(af){I=af+"";if(config.state==="dispay_1"&&ab===0&&ad<=7&&ad>0){config.frame=(config.frame+I)*1;ac();P();ad++}if(config.state==="dispay_1"&&ab===0&&ad===0&&I!="0"){config.frame="";config.frame=(config.frame+I)*1;ac();P();ad++}if(config.state==="dispay_1"&&ab===r&&ad<=7&&ad>0){config.delay=(config.delay+I)*1;P();ad++}if(config.state==="dispay_1"&&ab===r&&ad===0&&I!="0"){config.delay="";config.delay=(config.delay+I)*1;P();ad++}if(config.state==="dispay_1"&&ab===r*2&&ad<=7&&ad>0){config.pause=(config.pause+I)*1;P();ad++}if(config.state==="dispay_1"&&ab===r*2&&ad===0&&I!="0"){config.pause="";config.pause=(config.pause+I)*1;P();ad++}if(config.state==="dispay_1"&&ab===r*3&&ad<=7&&ad>0){config.speed=(config.speed+I)*1;ac();P();ad++}if(config.state==="dispay_1"&&ab===r*3&&ad===0&&I!="0"){config.speed="";config.speed=(config.speed+I)*1;P();ad++}if(config.state==="dispay_1"&&ab===r*4&&ad<=7&&ad>0){config.acceleration=(config.acceleration+I)*1;P();ad++}if(config.state==="dispay_1"&&ab===r*4&&ad===0&&I!="0"){config.acceleration="";config.acceleration=(config.acceleration+I)*1;P();ad++}if(config.state==="dispay_2"&&ab===0&&I==="1"){config.shootingMode="inter";O()}if(config.state==="dispay_2"&&ab===0&&I==="2"){config.shootingMode="seria";O()}if(config.state==="dispay_2"&&ab===0&&I==="3"){config.shootingMode="nonST";O()}if(config.state==="dispay_2"&&ab===0&&I==="4"){config.shootingMode="PingP";O()}if(config.state==="dispay_2"&&ab===r&&I==="1"){config.direction=1;O()}if(config.state==="dispay_2"&&ab===r&&I==="2"){config.direction=0;O()}if(config.state==="dispay_2"&&ab===r*2&&ad<=7&&ad>0){config.allSteps=(config.allSteps+I)*1;ac();O();ad++}if(config.state==="dispay_2"&&ab===r*2&&ad===0&&I!="0"){config.allSteps="";config.allSteps=(config.allSteps+I)*1;ac();O();ad++}}var ae;var o;var m;var x;var G;var s;var Z;var B;var v;var L;function ac(){console.log("NumControl");v=(config.allSteps/config.frame)/4;L=(config.speed/v)*10;config.framesLeft=config.frame;S=1;var af=config.allSteps/config.frame;ae=af/config.speed*500;var ag=af/4;o=ae/4;m=Math.floor(0.04*ag);if(m<=0){m=1}x=o/m;G=config.pause+config.delay+ae;s=G*config.frame;Z=s;B=ae;digitalWrite(X,config.direction)}function k(){digitalWrite(a,0);digitalWrite(t,p);if(config.shootingMode==="nonST"){config.state="started";F();return}if(config.framesLeft>0){config.state="started";b()}else{i()}}function i(){console.log(S);if(S>1+L){f();return}console.log("stop");clearInterval();config.state="waiting";digitalWrite(W,0);digitalWrite(a,1);digitalWrite(w,p);digitalWrite(t,V);ac();D();if(u){config.state="waiting";u.send(JSON.stringify(config))}}function F(){config.state="started";digitalWrite(t,p);J();config.framesLeft--;D();analogWrite(W,0.5,{freq:config.speed});var af=setInterval(function(){if(config.framesLeft<=0){clearInterval(af);i();return}J();config.framesLeft--;D()},B)}function J(){console.log("shot");digitalWrite(w,V);config.state="shot";var af=setTimeout(function(){config.state="waiting";digitalWrite(w,p);clearTimeout(af)},config.delay)}function n(){config.state="started";S=1;var af=config.allSteps/config.frame;var ag=setInterval(function(){if(v*3<af&&S<config.speed){S+=L;analogWrite(W,0.5,{freq:S})}if(v>=af&&S>100){S-=L;if(S<L+100){S=100}analogWrite(W,0.5,{freq:S})}if(S>config.speed){S=config.speed;analogWrite(W,0.5,{freq:S})}af-=S/100;if(af<=0){clearInterval(ag);Z=Z-G;digitalWrite(W,0);k();return}},10)}function f(){config.state="started";if(S<=1){i();return}var af=setInterval(function(){if(S<=1+L){clearInterval(af);i();return}S-=L;analogWrite(W,0.5,{freq:S})},10)}function b(){var af=setTimeout(function(){C();clearTimeout(af)},config.pause)}function C(){console.log("Relay");if(config.framesLeft>0){digitalWrite(w,V);config.framesLeft--;var af=setTimeout(function(){digitalWrite(w,p);if(u){u.send(JSON.stringify(config))}D();n();clearTimeout(af)},config.delay)}else{i()}}function e(){console.log("BtnStop");i()}function y(){D();k()}function A(){config.state="infinite";digitalWrite(t,p);g.clear();g.setFontVector(20);g.drawString("infinite",0,0);g.flip();digitalWrite(a,0);var af=setInterval(function(){analogWrite(W,0.5,{freq:S});S=S+L;if(S>=config.speed){clearInterval(af);analogWrite(W,0.5,{freq:config.speed})}},x)}function c(){config.state="90DEG";g.clear();g.setFontVector(20);g.drawString("turn to 90",0,0);g.flip();digitalWrite(a,0);analogWrite(W,0.5,{freq:config.speed});var af=0;setInterval(function(){if(af>=config.allSteps/4){i()}af=af+(config.speed/100)},10)}function j(){config.state="calibration";g.clear();g.setFontVector(20);g.drawString("calibration",0,0);g.flip();digitalWrite(a,0);var af=true;config.allSteps=0;analogWrite(W,0.5,{freq:config.speed});setInterval(function(){config.allSteps+=config.speed/100},10)}if(z){g=require("SH1106").connect(I2C1,l)}};function onInit(){I2C1.setup({scl:D22,sda:D21});fs=require("fs");config=JSON.parse(fs.readFileSync("cfg.htm"));config.state="waiting";config.firmwareVersion="PhotoPizza v6";var a=setTimeout(function(){run()},500)};
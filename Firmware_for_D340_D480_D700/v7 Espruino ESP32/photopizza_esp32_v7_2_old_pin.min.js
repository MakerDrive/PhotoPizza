const I2C_SDA=D21,I2C_SCL=D22,IR_DATA=D13,pinRelay=D26,pinLaser=D25,rOn=1,rOff=0,pinStep=D12,pinEn=D27,pinDir=D14,stOn=0,stOff=1,defConfig={firmwareVersion:"PhotoPizza v7",wifiSsid:"PhotoPizza",wifiPassword:"9994501234",wsPort:8e3,state:"waiting",framesLeft:36,frame:36,allSteps:109e3,pause:100,delay:300,speed:5e3,acceleration:100,shootingMode:"inter",direction:1,shutterT:200};var config={},run=function(){function n(){fs.writeFileSync("cfg.htm",JSON.stringify(config)),console.log("Save config")}var o,e,a="disconnected",t=require("Wifi"),s=1,c=!1;function r(){a="connection",h(),t.connect(config.wifiSsid,{password:config.wifiPassword},function(i){i?console.log("WiFi Connection error: "+i):(console.log(t.getIP()),a=t.getIP().ip,c=!0,h(),c&&((e=require("ws").createServer()).listen(config.wsPort),e.on("websocket",function(e){(o=e).send(JSON.stringify(config)),e.on("message",function(i){i=JSON.parse(i);config=i,P(),"start"===i.state&&"started"!=config.state&&(k(),config.state="started",e.send(JSON.stringify(config))),"infinity"===i.state&&"started"!=config.state&&(N(),e.send(JSON.stringify(config))),"stop"===i.state&&R(),"save"===i.state&&"started"!=config.state&&(n(),config.state="waiting",e.send(JSON.stringify(config)))}),e.on("close",function(){o=!1})})),t.on("disconnected",function(){o=c=!1,console.log("Lost WIFI! Disconnected."),a="disconnected",h(),1<=s&&(s--,setTimeout(function(){r()},2e3))}))})}t.startAP("PhotoPizza",{password:"9992030360",authMode:"wpa2"},function(i){if(i)throw i;console.log("Connected!"),a="192.168.4.1",(c=!0)&&((e=require("ws").createServer()).listen(config.wsPort),e.on("websocket",function(e){(o=e).send(JSON.stringify(config)),e.on("message",function(i){i=JSON.parse(i);config=i,P(),"start"===i.state&&"started"!=config.state&&(k(),config.state="started",e.send(JSON.stringify(config))),"infinity"===i.state&&"started"!=config.state&&(N(),e.send(JSON.stringify(config))),"stop"===i.state&&R(),"save"===i.state&&"started"!=config.state&&(config.state="waiting",n(),e.send(JSON.stringify(config)))}),e.on("close",function(){o=!1})})),t.on("disconnected",function(){o=c=!1,console.log("Lost WIFI! Disconnected."),a="disconnected",h(),1<=s&&(s--,setTimeout(function(){r()},2e3))})}),require("Font8x16").add(Graphics);var f,d,l,p,S,u,w,y,v="1",W=0,m=!0,O=0,I=13,i="",_=48,T=1;function h(){m&&(g.clear(),g.setFontVector(35),g.drawString(config.framesLeft+" f",0,0),g.flip(),g.setFontBitmap(),g.setFont8x16(),g.drawString("IP:"+a,0,45),g.flip())}function D(){m&&(config.state="dispay_1",4*I<O?O=0:O<0&&(O=4*I),g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(">",1,O),g.drawString(">",117,28),g.drawString("1",117,0),g.drawLine(112,0,112,127),g.drawString("frame",8,0),g.drawString("=",_,0),g.drawString(config.frame,57,0),g.drawString("delay",8,I),g.drawString("=",_,I),g.drawString(config.delay,57,I),g.drawString("pause",8,2*I),g.drawString("=",_,2*I),g.drawString(config.pause,57,2*I),g.drawString("speed",8,3*I),g.drawString("=",_,3*I),g.drawString(config.speed,57,3*I),g.drawString("accel",8,4*I),g.drawString("=",_,4*I),g.drawString(config.acceleration,57,4*I),g.flip())}function L(){m&&(i=1===config.direction?"right":"left",config.state="dispay_2",3*I<O?O=0:O<0&&(O=3*I),g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(">",1,O),g.drawString("<",117,28),g.drawString("2",117,0),g.drawLine(112,0,112,127),_=48,g.drawString("mode",8,0),g.drawString("=",_,0),g.drawString(config.shootingMode,57,0),g.drawString("direc",8,I),g.drawString("=",_,I),g.drawString(i,57,I),g.drawString("steps",8,2*I),g.drawString("=",_,2*I),g.drawString(config.allSteps,57,2*I),g.drawString("timeS",8,3*I),g.drawString("=",_,3*I),g.drawString(config.shutterT,57,3*I),g.flip())}function P(){console.log("NumControl"),w=config.allSteps/config.frame/4,y=config.speed/w*10,config.framesLeft=config.frame,T=1;var i=config.allSteps/config.frame;f=i/config.speed*500;i/=4;d=f/4,(S=Math.floor(.04*i))<=0&&(S=1),l=d/S,p=config.pause+config.delay+f,S=p*config.frame,u=f,digitalWrite(pinDir,config.direction)}function b(){if(digitalWrite(pinEn,0),digitalWrite(pinLaser,rOff),"nonST"===config.shootingMode)return config.state="started",void function(){config.state="started",digitalWrite(pinLaser,rOff),F(),config.framesLeft--,h(),analogWrite(pinStep,.5,{freq:config.speed});var i=setInterval(function(){return config.framesLeft<=0?(clearInterval(i),void E()):(F(),config.framesLeft--,void h())},u)}();var t;0<config.framesLeft?(config.state="started",t=setTimeout(function(){var i,e;console.log("Relay"),0<config.framesLeft?(digitalWrite(pinRelay,rOn),config.framesLeft--,i=setTimeout(function(){o&&o.send(JSON.stringify(config)),h(),function(){config.state="started",T=1;var i=config.allSteps/config.frame,e=setInterval(function(){3*w<i&&T<config.speed&&(T+=y,analogWrite(pinStep,.5,{freq:T})),i<=w&&100<T&&((T-=y)<y+100&&(T=100),analogWrite(pinStep,.5,{freq:T})),T>config.speed&&(T=config.speed,analogWrite(pinStep,.5,{freq:T})),(i-=T/100)<=0&&(clearInterval(e),digitalWrite(pinStep,0),b())},10)}(),clearTimeout(i)},config.delay),e=setTimeout(function(){digitalWrite(pinRelay,rOff),clearTimeout(e)},config.shutterT)):E(),clearTimeout(t)},config.pause)):E()}function E(){console.log(T),1+y<T?function(){if(config.state="started",T<=1)return E();var i=setInterval(function(){return T<=1+y?(clearInterval(i),void E()):(T-=y,void analogWrite(pinStep,.5,{freq:T}))},10)}():(console.log("stop"),clearInterval(),config.state="waiting",digitalWrite(pinStep,0),digitalWrite(pinEn,1),digitalWrite(pinRelay,rOff),digitalWrite(pinLaser,rOn),P(),h(),o&&(config.state="waiting",o.send(JSON.stringify(config))))}function F(){console.log("shot"),digitalWrite(pinRelay,rOn),config.state="shot";var i=setTimeout(function(){config.state="waiting",digitalWrite(pinRelay,rOff),clearTimeout(i)},config.delay)}function R(){console.log("BtnStop"),E()}function k(){h(),b()}function N(){config.state="infinite",digitalWrite(pinLaser,rOff),g.clear(),g.setFontVector(20),g.drawString("infinite",0,0),g.flip(),digitalWrite(pinEn,0);var i=setInterval(function(){analogWrite(pinStep,.5,{freq:T}),(T+=y)>=config.speed&&(clearInterval(i),analogWrite(pinStep,.5,{freq:config.speed}))},l)}digitalWrite(pinStep,0),digitalWrite(pinEn,1),digitalWrite(pinDir,config.direction),digitalWrite(pinRelay,rOff),digitalWrite(pinLaser,rOn),require("IRReceiver").connect(IR_DATA,function(e){var i=-1;try{i=parseInt(e,2)}catch(i){return void console.log("Unable to parse IR code: "+e+"With Error: "+i)}var t=-1;switch(i){case 6450803341:case 25803213367:case 17246882167:t=1;break;case 6450819151:case 25803276607:case 17246816887:t=2;break;case 6450786511:case 25803146047:case 17246947447:t=3;break;case 6450795181:case 25803180727:case 17246751607:t=4;break;case 6450810991:case 25803243967:case 17246718967:t=5;break;case 6450778351:case 25803113407:case 17246914807:t=6;break;case 6450799261:case 25803197047:case 17246945407:t=7;break;case 6450815071:case 25803260287:case 17246888287:t=8;break;case 6450782431:case 25803129727:case 17246863807:t=9;break;case 6450806911:case 25803227647:case 17246871967:t=0;break;case 6450774271:case 25803097087:t="SHOT";break;case 6450794416:case 25803177667:t="SAVE";break;case 25803148087:case 6450787021:case 17246823007:t="CALIBR";break;case 25803357187:case 6450839296:case 6450817621:t="POWER-W";break;case 6450823741:case 25803294967:case 17246896447:t="SETUP";break;case 6450800791:case 25803203167:case 17246741407:t="UP";break;case 6450796711:case 25803186847:case 17246792407:t="DOWN";break;case 6450809461:case 25803237847:case 17246733247:t="LEFT";break;case 6450776821:case 25803107287:case 17246808727:t="RIGHT";break;case 6450825271:case 25803301087:case 17246774047:t="OK";break;case 6450813031:case 25803252127:t="90DEG";break;case 6450835471:case 25803341887:t="WIFI";break;default:return void console.log("Unknown IR code: "+i)}if(console.log("Got IR code: "+i+" -> "+t),"SAVE"!==t)if("SHOT"!==t){if("POWER-W"!==t)return"number"==typeof t&&"dispay_1"===config.state||"number"==typeof t&&"dispay_2"===config.state||"number"==typeof t&&"newPass"===config.state?(console.log("input"),v=t+"","dispay_1"===config.state&&0===O&&W<=7&&0<W&&(config.frame=+(config.frame+v),P(),D(),W++),"dispay_1"===config.state&&0===O&&0===W&&"0"!=v&&(config.frame="",config.frame=+(config.frame+v),P(),D(),W++),"dispay_1"===config.state&&O===I&&W<=7&&0<W&&(config.delay=+(config.delay+v),D(),W++),"dispay_1"===config.state&&O===I&&0===W&&"0"!=v&&(config.delay="",config.delay=+(config.delay+v),D(),W++),"dispay_1"===config.state&&O===2*I&&W<=7&&0<W&&(config.pause=+(config.pause+v),D(),W++),"dispay_1"===config.state&&O===2*I&&0===W&&"0"!=v&&(config.pause="",config.pause=+(config.pause+v),D(),W++),"dispay_1"===config.state&&O===3*I&&W<=7&&0<W&&(config.speed=+(config.speed+v),P(),D(),W++),"dispay_1"===config.state&&O===3*I&&0===W&&"0"!=v&&(config.speed="",config.speed=+(config.speed+v),D(),W++),"dispay_1"===config.state&&O===4*I&&W<=7&&0<W&&(config.acceleration=+(config.acceleration+v),D(),W++),"dispay_1"===config.state&&O===4*I&&0===W&&"0"!=v&&(config.acceleration="",config.acceleration=+(config.acceleration+v),D(),W++),"dispay_2"===config.state&&0===O&&"1"==v&&(config.shootingMode="inter",L()),"dispay_2"===config.state&&0===O&&"2"==v&&(config.shootingMode="seria",L()),"dispay_2"===config.state&&0===O&&"3"==v&&(config.shootingMode="nonST",L()),"dispay_2"===config.state&&0===O&&"4"==v&&(config.shootingMode="PingP",L()),"dispay_2"===config.state&&O===I&&"1"==v&&(config.direction=1,L()),"dispay_2"===config.state&&O===I&&"2"==v&&(config.direction=0,L()),"dispay_2"===config.state&&O===2*I&&W<=7&&0<W&&(config.allSteps=+(config.allSteps+v),P(),L(),W++),"dispay_2"===config.state&&O===2*I&&0===W&&"0"!=v&&(config.allSteps="",config.allSteps=+(config.allSteps+v),P(),L(),W++),"dispay_2"===config.state&&O===3*I&&W<=7&&0<W&&(config.shutterT=+(config.shutterT+v),P(),L(),W++),void("dispay_2"===config.state&&O===3*I&&0===W&&"0"!=v&&(config.shutterT="",config.shutterT=+(config.shutterT+v),L(),W++))):"SETUP"===t&&"waiting"===config.state?(D(),console.log("Setup"),void(W=0)):"SETUP"===t&&"dispay_1"===config.state||"SETUP"===t&&"dispay_2"===config.state||"SETUP"===t&&"newWifi"===config.state?(config.state="waiting",P(),h(),n(),void console.log("Setup Exit")):"OK"===t&&"started"===config.state||"OK"===t&&"90DEG"===config.state||"OK"===t&&"calibration"===config.state||"OK"===t&&"infinite"===config.state||"OK"===t&&"shot"===config.state?(R(),console.log("OK STOP"),void(W=0)):"OK"===t&&"waiting"===config.state?(k(),console.log("OK START"),void(W=0)):"DOWN"===t&&"dispay_1"===config.state?(O+=I,D(),W=0,void console.log("Down D1")):"DOWN"===t&&"dispay_2"===config.state?(O+=I,L(),console.log("Down D2"),void(W=0)):"UP"===t&&"dispay_1"===config.state?(O-=I,D(),W=0,void console.log("UP D1")):"UP"===t&&"dispay_2"===config.state?(O-=I,L(),console.log("UP D2"),void(W=0)):"RIGHT"===t&&"dispay_1"===config.state?(L(),console.log("Right"),void(W=0)):"LEFT"===t&&"dispay_2"===config.state?(D(),console.log("Left"),void(W=0)):"RIGHT"===t&&"dispay_2"!=config.state?(digitalWrite(pinDir,1),digitalWrite(pinStep,0),digitalWrite(pinEn,stOn),T=1,N(),void console.log("Right rotation")):"LEFT"===t&&"dispay_1"!=config.state?(digitalWrite(pinDir,0),digitalWrite(pinStep,0),digitalWrite(pinEn,stOn),T=1,N(),void console.log("Left rotation")):"CALIBR"===t&&"dispay_1"===config.state||"CALIBR"===t&&"dispay_2"===config.state?(config.state="calibration",g.clear(),g.setFontVector(20),g.drawString("calibration",0,0),g.flip(),digitalWrite(pinEn,0),config.allSteps=0,analogWrite(pinStep,.5,{freq:config.speed}),void setInterval(function(){config.allSteps+=config.speed/100},10)):("CALIBR"===t&&"calibration"===config.state&&(E(),n()),"90DEG"!==t||"waiting"!==config.state?("90DEG"===t&&"90DEG"===config.state&&E(),"WIFI"===t&&"waiting"===config.state?(a="connection",h(),r(),console.log("WIFI"),void(W=0)):"UP"===t&&"infinite"===config.state?(config.speed=config.speed+config.stsp,void analogWrite(pinStep,.5,{freq:config.speed})):void("DOWN"===t&&"infinite"===config.state&&config.speed>config.stsp&&(config.speed=config.speed-config.stsp,analogWrite(pinStep,.5,{freq:config.speed})))):void function(){config.state="90DEG",g.clear(),g.setFontVector(20),g.drawString("turn to 90",0,0),g.flip(),digitalWrite(pinEn,0),analogWrite(pinStep,.5,{freq:config.speed});var i=0;setInterval(function(){i>=config.allSteps/4&&E(),i+=config.speed/100},10)}());digitalWrite(pinEn,0)}else F();else n()}),m&&(g=require("SH1106").connect(I2C1,function(){var i,e;m?(i=1,g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(config.firmwareVersion,10,45),g.flip(),e=setInterval(function(){g.setContrast(i),g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.drawLine(i,20,i,30),i+=2,g.flip(),126<i&&(clearInterval(e),P(),h())},10)):P()}))};function onInit(){I2C1.setup({scl:I2C_SCL,sda:I2C_SDA}),fs=require("fs");try{config=JSON.parse(fs.readFileSync("cfg.htm"))}catch(i){console.log("Formatting FS..."),E.flashFatFS({format:!0}),console.log("Writing Defconfig"),fs.writeFileSync("cfg.htm",JSON.stringify(defConfig)),config=JSON.parse(fs.readFileSync("cfg.htm")),console.log("Defconfig saved")}config.state="waiting",config.firmwareVersion="PhotoPizza v7";setTimeout(function(){run()},500)}
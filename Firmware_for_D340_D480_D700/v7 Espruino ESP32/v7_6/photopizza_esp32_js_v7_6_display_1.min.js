const I2C_SDA=D21,I2C_SCL=D22,IR_DATA=D13,pinRelay=D26,pinLaser=D25,rOn=0,rOff=1,pinStep=D12,pinEn=D27,pinDir=D14,stOn=0,stOff=1,defConfig={firmwareVersion:"PhotoPizza v7",wifiSsid:"",wifiPassword:"",wirelessType:"ap",wsPort:8e3,state:"waiting",framesLeft:32,frame:32,allSteps:109e3,pause:100,delay:300,speed:5e3,acceleration:100,shootingMode:"inter",direction:1,shutterT:200,degreesX:90};var config={},run=function(){function e(){config.state="save config",m&&(g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString("    Save config...",0,30),g.flip()),config.state="save config";var e=3;setInterval(function(){fs.writeFileSync("cfg.htm",JSON.stringify(config)),(e-=1)<=0&&(clearInterval(),console.log("Save config"),config.state="waiting",D())},1e3)}var i,n,t="disconnected",o=require("Wifi"),a=1,s=!1;function r(){t="connection",D(),o.connect(config.wifiSsid,{password:config.wifiPassword},function(g){g?console.log("WiFi Connection error: "+g):(console.log(o.getIP()),t=o.getIP().ip,s=!0,D(),s&&((n=require("ws").createServer()).listen(config.wsPort),n.on("websocket",function(n){i=n,n.send(JSON.stringify(config)),n.on("message",function(i){var t=JSON.parse(i);config=t,E(),"start"===t.state&&"started"!=config.state&&(q(),config.state="started",n.send(JSON.stringify(config))),"infinity"===t.state&&"started"!=config.state&&(k(),n.send(JSON.stringify(config))),"stop"===t.state&&R(),"save"===t.state&&"started"!=config.state&&(e(),config.state="waiting",n.send(JSON.stringify(config)))}),n.on("close",function(){i=!1})})),o.on("disconnected",function(){if(s=!1,i=!1,console.log("Lost WIFI! Disconnected."),t="disconnected",D(),a>=1){a--;setTimeout(function(){r()},2e3)}}))})}"ap"===config.wirelessType&&o.startAP("PhotoPizza",{password:"9992030360",authMode:"wpa2"},function(g){if(g)throw g;console.log("Connected!"),t="192.168.4.1",(s=!0)&&((n=require("ws").createServer()).listen(config.wsPort),n.on("websocket",function(n){i=n,n.send(JSON.stringify(config)),n.on("message",function(i){var t=JSON.parse(i);config=t,E(),"start"===t.state&&"started"!=config.state&&(q(),config.state="started",n.send(JSON.stringify(config))),"infinity"===t.state&&"started"!=config.state&&(k(),n.send(JSON.stringify(config))),"stop"===t.state&&R(),"save"===t.state&&"started"!=config.state&&(config.state="waiting",e(),n.send(JSON.stringify(config)))}),n.on("close",function(){i=!1})})),o.on("disconnected",function(){if(s=!1,i=!1,console.log("Lost WIFI! Disconnected."),t="disconnected",D(),a>=1){a--;setTimeout(function(){r()},2e3)}})}),"conn"===config.wirelessType&&r(),require("Font8x16").add(Graphics);var c,f,l,d,p,S,u,w,v,y="1",W=0,m=!0,I=0,h=13,O="",T=48,_=1;function D(){m&&(g.clear(),g.setFontVector(35),g.drawString(config.framesLeft+" f",0,0),g.flip(),g.setFontBitmap(),g.setFont8x16(),g.drawString("speed: "+config.speed,0,30),g.drawString("IP: "+t,0,45),g.flip())}function F(){m&&(config.state="dispay_1",I>4*h?I=0:I<0&&(I=4*h),g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(">",1,I),g.drawString(">",117,28),g.drawString("1",117,0),g.drawLine(112,0,112,127),g.drawString("frame",8,0),g.drawString("=",T,0),g.drawString(config.frame,57,0),g.drawString("delay",8,h),g.drawString("=",T,h),g.drawString(config.delay,57,h),g.drawString("pause",8,2*h),g.drawString("=",T,2*h),g.drawString(config.pause,57,2*h),g.drawString("speed",8,3*h),g.drawString("=",T,3*h),g.drawString(config.speed,57,3*h),g.drawString("degX",8,4*h),g.drawString("=",T,4*h),g.drawString(config.degreesX,57,4*h),g.flip())}function b(){m&&(O=1===config.direction?"right":"left",config.state="dispay_2",I>3*h?I=0:I<0&&(I=3*h),g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(">",1,I),g.drawString("<",117,28),g.drawString("2",117,0),g.drawLine(112,0,112,127),T=48,g.drawString("mode",8,0),g.drawString("=",T,0),g.drawString(config.shootingMode,57,0),g.drawString("direc",8,h),g.drawString("=",T,h),g.drawString(O,57,h),g.drawString("steps",8,2*h),g.drawString("=",T,2*h),g.drawString(config.allSteps,57,2*h),g.drawString("timeS",8,3*h),g.drawString("=",T,3*h),g.drawString(config.shutterT,57,3*h),g.drawString("wifi",8,4*h),g.drawString("=",T,4*h),g.drawString(config.degreesX,57,4*h),g.flip())}function E(){console.log("NumControl"),u=config.allSteps/config.frame/4,w=config.speed/u*10,config.framesLeft=config.frame,_=1;var e=config.allSteps/config.frame;c=e/config.speed*500;var i=e/4;f=c/4,(l=Math.floor(.04*i))<=0&&(l=1),d=f/l,p=config.pause+config.delay+c,S=p*config.frame,S,c,v=Math.ceil(.29*config.speed-config.allSteps/config.frame/40),digitalWrite(pinDir,config.direction)}function L(){if(digitalWrite(pinEn,0),digitalWrite(pinLaser,rOff),"nonST"===config.shootingMode||"seria"===config.shootingMode)return config.state="started",void function(){digitalWrite(pinEn,0),1===config.direction?digitalWrite(pinDir,0):digitalWrite(pinDir,1);config.state="started",m&&(g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString("   No stop spin",0,30),g.flip());_=1;var e=Math.ceil(.29*config.speed-config.allSteps/(360/config.degreesX)/40);console.log(e);var i=Math.ceil((config.allSteps+e)/(360/config.degreesX)),n=config.allSteps/(360/config.degreesX)/4,t=config.speed/n*10,o=setInterval(function(){if(3*n<i&&_<config.speed&&(_+=t,analogWrite(pinStep,.5,{freq:_})),n>=i&&_>500&&((_-=t)<t+100&&(_=100),analogWrite(pinStep,.5,{freq:_})),_>config.speed&&(_=config.speed,analogWrite(pinStep,.5,{freq:_})),(i-=_/100)<=0)return clearInterval(o),void function(){digitalWrite(pinDir,config.direction),_=1;var e=Math.ceil(.29*config.speed-config.allSteps/(360/config.degreesX)/40);console.log(e);var i=Math.ceil((config.allSteps+e)/(360/config.degreesX)),n=config.allSteps/(360/config.degreesX)/4,t=config.speed/n*10,o=setInterval(function(){if(3*n<i&&_<config.speed&&(_+=t,analogWrite(pinStep,.5,{freq:_})),(i-=_/100)<=0)return clearInterval(o),void function(){var e=config.allSteps+v+.9*_,i=config.allSteps+v+.9*_,n=i/config.frame;digitalWrite(pinRelay,rOn);var t=setInterval(function(){if(e-=_/100,(n-=_/100)<=0&&"seria"!=config.shootingMode&&(digitalWrite(pinRelay,rOn),n=i/config.frame),n<=i/config.frame/2&&"seria"!=config.shootingMode&&digitalWrite(pinRelay,rOff),e<=0)return clearInterval(t),digitalWrite(pinRelay,rOff),void function(){var e=Math.ceil(.29*config.speed-config.allSteps/(360/config.degreesX)/40);console.log(e);var i=Math.ceil((config.allSteps+e)/(360/config.degreesX)),n=config.allSteps/(360/config.degreesX)/4,t=config.speed/n*10,o=setInterval(function(){if(n>=i&&_>500&&((_-=t)<t+100&&(_=100),analogWrite(pinStep,.5,{freq:_})),(i-=_/100)<=0)return clearInterval(o),void function(){digitalWrite(pinEn,0),1===config.direction?digitalWrite(pinDir,0):digitalWrite(pinDir,1);_=1;var e=Math.ceil(.29*config.speed-config.allSteps/(360/config.degreesX)/40);console.log(e);var i=Math.ceil((config.allSteps+e)/(360/config.degreesX)),n=config.allSteps/(360/config.degreesX)/4,t=config.speed/n*10,o=setInterval(function(){if(3*n<i&&_<config.speed&&(_+=t,analogWrite(pinStep,.5,{freq:_})),n>=i&&_>500&&((_-=t)<t+100&&(_=100),analogWrite(pinStep,.5,{freq:_})),_>config.speed&&(_=config.speed,analogWrite(pinStep,.5,{freq:_})),(i-=_/100)<=0)return clearInterval(o),void P()},10)}()},10)}()},10)}()},10)}()},10)}();var e;config.framesLeft>0?(config.state="started",e=setTimeout(function(){!function(){if(console.log("Relay"),config.framesLeft>0){digitalWrite(pinRelay,rOn),config.framesLeft--;var e=setTimeout(function(){i&&i.send(JSON.stringify(config)),D(),function(){config.state="started",_=1;var e=(config.allSteps+v)/config.frame,i=setInterval(function(){if(3*u<e&&_<config.speed&&(_+=w,analogWrite(pinStep,.5,{freq:_})),u>=e&&_>500&&((_-=w)<w+100&&(_=100),analogWrite(pinStep,.5,{freq:_})),_>config.speed&&(_=config.speed,analogWrite(pinStep,.5,{freq:_})),(e-=_/100)<=0)return clearInterval(i),p,digitalWrite(pinStep,0),void L()},10)}(),clearTimeout(e)},config.delay),n=setTimeout(function(){digitalWrite(pinRelay,rOff),clearTimeout(n)},config.shutterT)}else P()}(),clearTimeout(e)},config.pause)):P()}function P(){console.log(_),_>1+w?function(){if(config.state="started",_<=1)return void P();var e=setInterval(function(){if(_<=1+w)return clearInterval(e),void P();_-=w,analogWrite(pinStep,.5,{freq:_})},10)}():(console.log("stop"),clearInterval(),config.state="waiting",digitalWrite(pinStep,0),digitalWrite(pinEn,1),digitalWrite(pinRelay,rOff),digitalWrite(pinLaser,rOn),digitalWrite(pinDir,config.direction),E(),D(),i&&(config.state="waiting",i.send(JSON.stringify(config))))}function R(){console.log("BtnStop"),P()}function q(){D(),L()}function k(){config.state="infinite",digitalWrite(pinLaser,rOff),m&&(g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(" spins endlessly",0,30),g.flip()),digitalWrite(pinEn,0);var e=setInterval(function(){analogWrite(pinStep,.5,{freq:_}),(_+=w)>=config.speed&&(clearInterval(e),analogWrite(pinStep,.5,{freq:config.speed}))},d)}digitalWrite(pinStep,0),digitalWrite(pinEn,1),digitalWrite(pinDir,config.direction),digitalWrite(pinRelay,rOff),digitalWrite(pinLaser,rOn),require("IRReceiver").connect(IR_DATA,function(i){var n=-1;try{n=parseInt(i,2)}catch(e){return void console.log("Unable to parse IR code: "+i+"With Error: "+e)}var o=-1;switch(n){case 6450803341:case 25803213367:case 17246882167:o=1;break;case 6450819151:case 25803276607:case 17246816887:o=2;break;case 6450786511:case 25803146047:case 17246947447:o=3;break;case 6450795181:case 25803180727:case 17246751607:o=4;break;case 6450810991:case 25803243967:case 17246718967:o=5;break;case 6450778351:case 25803113407:case 17246914807:o=6;break;case 6450799261:case 25803197047:case 17246945407:o=7;break;case 6450815071:case 25803260287:case 17246888287:o=8;break;case 6450782431:case 25803129727:case 17246863807:o=9;break;case 6450806911:case 25803227647:case 17246871967:o=0;break;case 6450774271:case 25803097087:o="SHOT";break;case 6450794416:case 25803177667:case 25803254167:o="SAVE";break;case 25803148087:case 6450787021:case 17246823007:o="CALIBR";break;case 25803357187:case 6450839296:case 6450817621:o="POWER-W";break;case 6450823741:case 25803294967:case 17246896447:o="SETUP";break;case 6450800791:case 25803203167:case 17246741407:o="UP";break;case 6450796711:case 25803186847:case 17246792407:o="DOWN";break;case 6450809461:case 25803237847:case 17246733247:o="LEFT";break;case 6450776821:case 25803107287:case 17246808727:o="RIGHT";break;case 6450825271:case 25803301087:case 17246774047:o="OK";break;case 6450813031:case 25803252127:o="DEG";break;case 6450835471:case 25803341887:o="WIFI";break;default:return void console.log("Unknown IR code: "+n)}if(console.log("Got IR code: "+n+" -> "+o),"SAVE"!==o)if("SHOT"!==o)if("POWER-W"!==o){if("number"==typeof o&&"dispay_1"===config.state||"number"==typeof o&&"dispay_2"===config.state||"number"==typeof o&&"newPass"===config.state)return console.log("input"),void function(e){y=e+"","dispay_1"===config.state&&0===I&&W<=7&&W>0&&(config.frame=1*(config.frame+y),E(),F(),W++);"dispay_1"===config.state&&0===I&&0===W&&"0"!=y&&(config.frame="",config.frame=1*(config.frame+y),E(),F(),W++);"dispay_1"===config.state&&I===h&&W<=7&&W>0&&(config.delay=1*(config.delay+y),F(),W++);"dispay_1"===config.state&&I===h&&0===W&&"0"!=y&&(config.delay="",config.delay=1*(config.delay+y),F(),W++);"dispay_1"===config.state&&I===2*h&&W<=7&&W>0&&(config.pause=1*(config.pause+y),F(),W++);"dispay_1"===config.state&&I===2*h&&0===W&&"0"!=y&&(config.pause="",config.pause=1*(config.pause+y),F(),W++);"dispay_1"===config.state&&I===3*h&&W<=7&&W>0&&(config.speed=1*(config.speed+y),E(),F(),W++);"dispay_1"===config.state&&I===3*h&&0===W&&"0"!=y&&(config.speed="",config.speed=1*(config.speed+y),F(),W++);"dispay_1"===config.state&&I===4*h&&W<=7&&W>0&&(config.degreesX=1*(config.degreesX+y),F(),W++);"dispay_1"===config.state&&I===4*h&&0===W&&"0"!=y&&(config.degreesX="",config.degreesX=1*(config.degreesX+y),F(),W++);"dispay_2"===config.state&&0===I&&"1"===y&&(config.shootingMode="inter",b());"dispay_2"===config.state&&0===I&&"2"===y&&(config.shootingMode="seria",b());"dispay_2"===config.state&&0===I&&"3"===y&&(config.shootingMode="nonST",b());"dispay_2"===config.state&&0===I&&"4"===y&&(config.shootingMode="PingP",b());"dispay_2"===config.state&&I===h&&"1"===y&&(config.direction=1,b());"dispay_2"===config.state&&I===h&&"2"===y&&(config.direction=0,b());"dispay_2"===config.state&&I===2*h&&W<=7&&W>0&&(config.allSteps=1*(config.allSteps+y),E(),b(),W++);"dispay_2"===config.state&&I===2*h&&0===W&&"0"!=y&&(config.allSteps="",config.allSteps=1*(config.allSteps+y),E(),b(),W++);"dispay_2"===config.state&&I===3*h&&W<=7&&W>0&&(config.shutterT=1*(config.shutterT+y),E(),b(),W++);"dispay_2"===config.state&&I===3*h&&0===W&&"0"!=y&&(config.shutterT="",config.shutterT=1*(config.shutterT+y),b(),W++);"dispay_2"===config.state&&I===4*h&&"1"===y&&(config.wirelessType="ap",b());"dispay_2"===config.state&&I===4*h&&"2"===y&&(config.wirelessType="conn",b());"dispay_2"===config.state&&I===4*h&&"0"===y&&(config.wirelessType="off",b())}(o);if("SETUP"===o&&"waiting"===config.state)return F(),console.log("Setup"),void(W=0);if("SETUP"===o&&"dispay_1"===config.state||"SETUP"===o&&"dispay_2"===config.state||"SETUP"===o&&"newWifi"===config.state)return config.state="waiting",E(),e(),void console.log("Setup Exit");if("OK"===o&&"started"===config.state||"OK"===o&&"DEG"===config.state||"OK"===o&&"calibration"===config.state||"OK"===o&&"infinite"===config.state||"OK"===o&&"shot"===config.state)return R(),console.log("OK STOP"),void(W=0);if("OK"===o&&"waiting"===config.state)return q(),console.log("OK START"),void(W=0);if("DOWN"===o&&"dispay_1"===config.state)return I+=h,F(),W=0,void console.log("Down D1");if("DOWN"===o&&"dispay_2"===config.state)return I+=h,b(),console.log("Down D2"),void(W=0);if("UP"===o&&"dispay_1"===config.state)return I-=h,F(),W=0,void console.log("UP D1");if("UP"===o&&"dispay_2"===config.state)return I-=h,b(),console.log("UP D2"),void(W=0);if("RIGHT"===o&&"dispay_1"===config.state)return b(),console.log("Right"),void(W=0);if("LEFT"===o&&"dispay_2"===config.state)return F(),console.log("Left"),void(W=0);if("RIGHT"===o&&"dispay_2"!=config.state)return digitalWrite(pinDir,1),digitalWrite(pinStep,0),digitalWrite(pinEn,0),_=1,k(),void console.log("Right rotation");if("LEFT"===o&&"dispay_1"!=config.state)return digitalWrite(pinDir,0),digitalWrite(pinStep,0),digitalWrite(pinEn,0),_=1,k(),void console.log("Left rotation");if("CALIBR"===o&&"dispay_1"===config.state||"CALIBR"===o&&"dispay_2"===config.state)!function(){config.state="calibration",g.clear(),g.setFontVector(20),g.drawString("calibration",0,0),g.flip(),digitalWrite(pinEn,0);config.allSteps=0,analogWrite(pinStep,.5,{freq:config.speed}),setInterval(function(){config.allSteps+=config.speed/100},10)}();else{if("CALIBR"===o&&"calibration"===config.state){var a=Math.ceil(.03*config.allSteps);config.allSteps=config.allSteps-a,P(),e()}if("DEG"!==o||"waiting"!==config.state)return"DEG"===o&&"DEG"===config.state&&P(),"WIFI"===o&&"waiting"===config.state?(t="connection",D(),r(),console.log("WIFI"),void(W=0)):"UP"===o&&"infinite"===config.state?(config.speed=config.speed+config.stsp,void analogWrite(pinStep,.5,{freq:config.speed})):"DOWN"===o&&"infinite"===config.state&&config.speed>config.stsp?(config.speed=config.speed-config.stsp,void analogWrite(pinStep,.5,{freq:config.speed})):void 0;!function(){digitalWrite(pinEn,0),config.state="started",g.clear(),g.setFontVector(20),g.drawString("turn to: "+config.degreesX+"°",0,0),g.flip(),_=1;var e=Math.ceil(.29*config.speed-config.allSteps/(360/config.degreesX)/40);console.log(e);var i=Math.ceil((config.allSteps+e)/(360/config.degreesX)),n=config.allSteps/(360/config.degreesX)/4,t=config.speed/n*10,o=setInterval(function(){if(3*n<i&&_<config.speed&&(_+=t,analogWrite(pinStep,.5,{freq:_})),n>=i&&_>500&&((_-=t)<t+100&&(_=100),analogWrite(pinStep,.5,{freq:_})),_>config.speed&&(_=config.speed,analogWrite(pinStep,.5,{freq:_})),(i-=_/100)<=0)return clearInterval(o),digitalWrite(pinStep,0),void P()},10)}()}}else digitalWrite(pinEn,0);else!function(){console.log("shot"),digitalWrite(pinRelay,rOn),config.state="shot";var e=setTimeout(function(){config.state="waiting",digitalWrite(pinRelay,rOff),clearTimeout(e)},config.delay)}();else e()}),m&&(g=require("SSD1306").connect(I2C1,function(){if(m){var e=1;g.clear(),g.setFontBitmap(),g.setFont8x16(),g.drawString(config.firmwareVersion,10,45),g.flip();var i=setInterval(function(){g.setContrast(e),g.drawLine(e,20,e,30),e+=2,g.drawLine(e,20,e,30),e+=2,g.drawLine(e,20,e,30),e+=2,g.drawLine(e,20,e,30),e+=2,g.drawLine(e,20,e,30),e+=2,g.drawLine(e,20,e,30),e+=2,g.flip(),e>126&&(clearInterval(i),E(),D())},10)}else E()}))};function onInit(){I2C1.setup({scl:I2C_SCL,sda:I2C_SDA}),fs=require("fs");try{config=JSON.parse(fs.readFileSync("cfg.htm"))}catch(e){console.log("Formatting FS..."),E.flashFatFS({format:!0}),console.log("Writing Defconfig"),fs.writeFileSync("cfg.htm",JSON.stringify(defConfig)),config=JSON.parse(fs.readFileSync("cfg.htm")),console.log("Defconfig saved")}config.state="waiting",config.firmwareVersion="PhotoPizza v7.6";setTimeout(function(){run()},500)}